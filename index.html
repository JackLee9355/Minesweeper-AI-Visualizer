<!DOCTYPE html>
<html>
	<head>
		
		<title>Minesweeper AI</title>
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
		<link rel="stylesheet" href="./main.css">

		<script src="./minesweeper.js" type="text/javascript"></script>
		<script type="text/javascript">

			let board = null;
			let aiWorker = null;

			function newGame(numRows, numColumns, mines) {
				rows = numRows;
				columns = numColumns;
				let tableDiv = document.getElementById('board');
				let table = document.createElement('table');
				table.setAttribute('id', 'boardTable');
				table.setAttribute('class', 'board-table');

				let boardArr = [];
				for(let row = 0; row < rows; row++) {
					let tableRow = document.createElement('tr');
					boardArr[row] = [];
					for(let column = 0; column < columns; column++) {
						let cell = document.createElement('td');
						cell.setAttribute('row', row);
						cell.setAttribute('column', column);
						cell.setAttribute('class', 'board-cell');
						let location = new Location(row, column, false, 0, false);
						cell.innerText = '?';
						cell.setAttribute('onclick', 'cellClick(this);');
						boardArr[row][column] = location;
						tableRow.appendChild(cell);
					}
					table.appendChild(tableRow);
				}
				board = new Board(boardArr);

				let oldTable = document.getElementById('boardTable');
				if(oldTable != null) {
					tableDiv.replaceChild(table, oldTable);
				} else {
					tableDiv.appendChild(table)
				}

				board.distributeMines(mines);

				return tableDiv;
			}

			function getLocationElement(location) {
				let table = document.getElementById('boardTable');
				return table.rows[location.row].cells[location.col];
			}

			function cellClick(cellClicked) {
				let toReveal = board.getSquaresToReveal(board.arr[cellClicked.getAttribute('row')][cellClicked.getAttribute('column')]);
				toReveal.forEach(location => {
					getLocationElement(location).innerText = location.isMine ? 'M' : location.adjacentMines;
				});
			}

			function startAi(maxDepth, useOverallRule) {
				if(aiWorker != null) {
					aiWorker.terminate();
				}
				aiWorker = new Worker('./minesweeperAI.js');
				aiWorker.onmessage = onMessage;
				aiWorker.postMessage({action:'START', boardArr:board.arr, maxDepth:maxDepth, useOverallRule:useOverallRule});
			}

			function onMessage(message) {
				if(message.data.action == 'NEW_RULES') {
					board = new Board(message.data.boardArr);
					console.log('New board received.');
					drawRules(message.data.currentDepth);
				} else if(message.data.action == 'FINISH') {
					console.log('Terminating AI worker.')
					aiWorker.terminate();
					aiWorker = null;
				}
			}

			function drawRules(maxGeneration) {
				for(let row = 0; row < board.rows; row++) {
					for(let col = 0; col < board.cols; col++) {
						let loc = board.arr[row][col];
						let element = getLocationElement(loc);
						let newClassName = "board-cell";
						if(!loc.isRevealed) {
							if(loc.rules.length > 0) {
								newClassName = 'unsure board-cell';
							}
							loc.rules.forEach(rule => {
								if(rule.mines == 0) {
									newClassName = 'safe board-cell';
									return;
								} else if(rule.mines == rule.locations.length) {
									newClassName = 'danger board-cell';
									return;
								}
							});
							element.className = newClassName;
						}
					}
				}
			}

		</script>
	</head>
	<body>
		<br>
		<table>
			<tr>
				<td>
					Rows:
				</td>
				<td>
					Columns:
				</td>
				<td>
					Mines:
				</td>
				<td>
					Max AI Depth:
				</td>
				<td>
					Overall Rule:
				</td>
			</tr>
			<tr>
				<td>
					<input type="text" id="rowInput" value="12"></input>
				</td>
				<td>
					<input type="text" id="columnInput" value="12"></input>
				</td>
				<td>
					<input type="text" id="mineInput" value="30"></input>
				</td>
				<td>
					<input type="text" id="maxDepth" value="4"></input>
				</td>
				<td>
					<input type="checkbox" id="overallRule"></input>
				</td>
			</tr>
		</table>
		<div>
			<button onclick="newGame(document.getElementById('rowInput').value,
				document.getElementById('columnInput').value,
				document.getElementById('mineInput').value);">
				New Game
			</button>
			<button onclick="startAi(document.getElementById('maxDepth').value,
				document.getElementById('overallRule').checked);">
				Start Ai
			</button>
		</div>
		<br>
		<br>
		<table>
			<tr>
				<td>
					<div id="board">
					</div>
				</td>
				<td style="padding: 25px;">
					Other Info will go here.
				</td>
			</tr>
		</table>

		<div class="credits">
			<a href="https://github.com/JackLee9355/Minesweeper-AI-Visualizer">Learn more here</a>
			<br>
			Made by Jack Lee (JackLee9355@gmail.com)
		</div>
	</body>

	<script>
		// Set up the default board.
		newGame(12, 12, 30);
	</script>
</html>